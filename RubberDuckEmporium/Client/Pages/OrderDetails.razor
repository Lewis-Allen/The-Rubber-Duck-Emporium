@page "/orders/{OrderID:guid}"
@inject IOrderService OrderService
@implements IDisposable
@attribute [Authorize]

<h1>Order Details</h1>

@if (CurrentOrder is null)
{
    <Loading />
}
else
{
    <ul>
        <li>Order ID: @CurrentOrder.OrderID</li>
        <li>Current Status: @GetStatusMessage(CurrentStatus)</li>
        <li>
            Items:
            <ul>
                @foreach (var orderItem in CurrentOrder.OrderItems.OrderBy(oi => oi.Product.Name))
                {
                    <li>@orderItem.Product.Name - @orderItem.Quantity - <strong>@(orderItem.Product.Price * orderItem.Quantity) DuckBucks</strong></li>
                }
            </ul>
        </li>
        <li>Order Total: <strong>@CurrentOrder.OrderItems.Sum(oi => oi.Quantity * oi.Product.Price) DuckBucks</strong></li>
    </ul>
}

<NavLink class="nav-link" href="orders">
    <button class="btn btn-secondary">
        Back to Orders
    </button>
</NavLink>

@code {

    [Parameter]
    public Guid OrderID { get; set; }

    public OrderModel CurrentOrder { get; set; }

    public OrderStatus CurrentStatus { get; set; }

    CancellationTokenSource cancellationToken;

    protected async override Task OnParametersSetAsync()
    {
        CurrentOrder = await OrderService.Retrieve(OrderID);

        cancellationToken?.Cancel();

        PollStatus();
    }

    private async void PollStatus()
    {
        cancellationToken = new CancellationTokenSource();

        while(!cancellationToken.IsCancellationRequested)
        {
            CurrentStatus = OrderModel.GetStatus(CurrentOrder);
            StateHasChanged();

            if (CurrentStatus == OrderStatus.Delivered)
            {
                cancellationToken.Cancel();
            }
            else
            {
                await Task.Delay(5000);
            }
        }
    }

    private string GetStatusMessage(OrderStatus status) =>
        status switch
        {
            OrderStatus.OrderPlaced => "The order has been placed and will actioned shortly.",
            OrderStatus.PreparingForDispatch => "Our warehouse workers are preparing the order for dispatch.",
            OrderStatus.Dispatched => "The order has been dispatched to a distribution centre near you.",
            OrderStatus.OutForDelivery => "A courier will be delivering your order today.",
            OrderStatus.Delivered => "Your order has been delivered. Enjoy!",
            _ => ""
        };


    void IDisposable.Dispose()
    {
        cancellationToken?.Cancel();
    }
}